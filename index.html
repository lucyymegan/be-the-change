<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Be The Change: Be part of something bigger — MVP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; justify-content:space-between; align-items:center; }
    section { border:1px solid #ddd; padding:12px; margin-top:16px; border-radius:6px; }
    label { display:block; margin-top:8px; }
    input, textarea, select { width:100%; padding:8px; margin-top:4px; box-sizing:border-box; }
    button { margin-top:8px; padding:8px 12px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .small { font-size:0.9em; color:#555; }
    .entry { border-bottom:1px solid #eee; padding:8px 0; }
    .tag { display:inline-block; background:#eef; padding:2px 8px; border-radius:10px; margin-left:8px; font-size:0.85em; }
    .admin { background:#fff7e6; }
    .counts { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
    .count-card { padding:8px 12px; border-radius:6px; border:1px solid #ddd; }
  </style>
</head>
<body>
  <header>
    <h1>Be The Change: Be part of something bigger — MVP</h1>
    <div id="auth-area" class="small">
      <span id="user-email">Not signed in</span>
      <button id="btn-logout" style="display:none">Log out</button>
    </div>
  </header>

  <!-- Creating right-hand pane -->
  <div class="layout" style="display:grid;grid-template-columns:1fr 260px;gap:24px;">
    <main class="main-content">
      <!-- keep your existing sections (dashboard, submit, profile-section, admin, etc.) here -->
    </main>

    <aside id="profile-summary" style="display:none">
      <div class="profile-card" style="border:1px solid #ddd;border-radius:8px;padding:12px;background:#fafafa">
        <img id="summary-avatar" src="https://via.placeholder.com/120?text=User" alt="avatar" style="width:100%;max-width:120px;border-radius:50%;display:block;margin-bottom:8px" />
        <h3 id="summary-name" style="margin:6px 0 4px 0"></h3>
        <p id="summary-bio" class="small" style="min-height:40px"></p>
        <div class="small"><strong id="summary-count">0</strong> actions logged</div>
        <a href="#" id="open-profile" style="display:block;margin-top:8px">View full profile →</a>
      </div>
    </aside>
  </div>

  <!-- Authentication -->
  <section id="auth-section">
    <strong>Sign up / Log in (Email)</strong>
    <div class="row">
      <div style="flex:1 1 260px">
        <label>Email<input id="email" type="email" /></label>
        <label>Password<input id="password" type="password" /></label>
        <button id="btn-signup">Sign up</button>
        <button id="btn-login">Log in</button>
      </div>
      <div style="flex:1 1 260px">
        <div class="small">After signing up, record the UID shown in console (or in user management in Firebase) and create an admins/{UID} document with enabled=true in Firestore to enable the admin panel for that account.</div>
      </div>
    </div>
  </section>

  <!-- Submit form -->
  <section id="submit-section" style="display:none">
    <strong>Submit something you did</strong>
    <label>Short description<textarea id="entry-text" rows="3" placeholder="What did you do?"></textarea></label>
    <label>Tag
      <select id="entry-tag">
        <option value="environment">Environment</option>
        <option value="charity">Charity</option>
        <option value="community">Community</option>
        <option value="kindness">Kindness</option>
        <option value="other">Other</option>
      </select>
    </label>
    <button id="btn-submit">Submit (goes to pending)</button>
    <div id="submit-status" class="small"></div>
  </section>

  <!-- Dashboard (approved items) -->
  <section id="dashboard-section">
    <strong>Dashboard — approved entries</strong>
    <div class="small">Total approved: <span id="total-count">0</span></div>
    <div class="counts" id="tag-counts"></div>
    <div id="approved-list"></div>
  </section>

  <!-- Profile section -->
  <section id="profile-section" style="display:none">
    <strong>My profile</strong>
    <div>
      <label>Display name<input id="profile-name" type="text"/></label>
      <label>Bio<textarea id="profile-bio" rows="3"></textarea></label>
      <label>Avatar URL<input id="profile-avatar" type="url" placeholder="https://..." /></label>
      <button id="btn-save-profile">Save profile</button>
      <div id="profile-save-status" class="small"></div>
    </div>

    <div style="margin-top:12px">
      <strong>My submissions</strong>
      <div id="my-submissions-list" class="small">Loading…</div>
    </div>
  </section>

  <!-- Admin panel -->
  <section id="admin-section" style="display:none" class="admin">
    <strong>Admin panel — pending submissions</strong>
    <div id="pending-list" class="small"></div>
  </section>

  <!-- Firebase SDKs (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAZi3WI84OKkzUADIRH-oYwgy_xSHZU-OE",
      authDomain: "be-the-change-bd30d.firebaseapp.com",
      projectId: "be-the-change-bd30d",
      storageBucket: "be-the-change-bd30d.firebasestorage.app",
      messagingSenderId: "627286973176",
      appId: "1:627286973176:web:f8d5580c9dc29f4bb8790d",
      measurementId: "G-0TVCHS9DVV"
    };
    // ----------------------------

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI refs
    const emailEl = document.getElementById('email');
    const pwEl = document.getElementById('password');
    const btnSignup = document.getElementById('btn-signup');
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const userEmailSpan = document.getElementById('user-email');

    const submitSection = document.getElementById('submit-section');
    const btnSubmit = document.getElementById('btn-submit');
    const entryText = document.getElementById('entry-text');
    const entryTag = document.getElementById('entry-tag');
    const submitStatus = document.getElementById('submit-status');

    const approvedListEl = document.getElementById('approved-list');
    const totalCountEl = document.getElementById('total-count');
    const tagCountsEl = document.getElementById('tag-counts');

    const profileSection = document.getElementById('profile-section');
    const profileNameEl = document.getElementById('profile-name');
    const profileBioEl = document.getElementById('profile-bio');
    const profileAvatarEl = document.getElementById('profile-avatar');
    const btnSaveProfile = document.getElementById('btn-save-profile');
    const profileSaveStatus = document.getElementById('profile-save-status');
    const mySubmissionsList = document.getElementById('my-submissions-list');

    const adminSection = document.getElementById('admin-section');
    const pendingListEl = document.getElementById('pending-list');

    let currentUser = null;
    let mySubmissionsUnsub = null;

    // Authentication handlers
    btnSignup.addEventListener('click', async () => {
      try {
        const userCred = await auth.createUserWithEmailAndPassword(emailEl.value.trim(), pwEl.value);
        console.log('Signed up UID:', userCred.user.uid);
        alert('Signed up. Check console for UID; create admins/{UID} in Firestore for admin access.');
      } catch (err) {
        alert('Signup error: ' + err.message);
      }
    });

    btnLogin.addEventListener('click', async () => {
      try {
        await auth.signInWithEmailAndPassword(emailEl.value.trim(), pwEl.value);
      } catch (err) {
        alert('Login error: ' + err.message);
      }
    });

    btnLogout.addEventListener('click', async () => {
      try {
        await auth.signOut();
      } catch (e) {
        console.error('Logout failed', e);
      }
    });

    // Auth state change: show/hide UI and attach per-user listeners
    auth.onAuthStateChanged(async (user) => {
      currentUser = user;

      // cleanup previous per-user listener
      if (mySubmissionsUnsub) {
        mySubmissionsUnsub();
        mySubmissionsUnsub = null;
      }

      if (user) {
        userEmailSpan.textContent = user.email;
        btnLogout.style.display = 'inline-block';
        submitSection.style.display = 'block';
        profileSection.style.display = 'block';

        // load profile fields and attach real-time listener for user's submissions
        loadUserProfile();
        attachMySubmissionsListener();

        // CHECK ADMIN VIA FIRESTORE and do immediate pending fetch if admin
        try {
          const adminDoc = await db.collection('admins').doc(user.uid).get();
          if (adminDoc.exists && adminDoc.data().enabled === true) {
            adminSection.style.display = 'block';
            // immediate one-time fetch to ensure admin UI populates right away
            try {
              const snap = await db.collection('submissions')
                .where('status', '==', 'pending')
                .orderBy('timestamp', 'asc')
                .get();
              const items = [];
              snap.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
              renderPending(items);
            } catch (err) {
              console.error('Immediate pending fetch failed:', err);
            }
          } else {
            adminSection.style.display = 'none';
          }
        } catch (err) {
          console.error('Admin check failed:', err);
          adminSection.style.display = 'none';
        }

      } else {
        userEmailSpan.textContent = 'Not signed in';
        btnLogout.style.display = 'none';
        submitSection.style.display = 'none';
        profileSection.style.display = 'none';
        adminSection.style.display = 'none';
      }
    });

    // Submit an entry -> writes a document with status 'pending'
    btnSubmit.addEventListener('click', async () => {
      const text = entryText.value.trim();
      const tag = entryTag.value;
      if (!currentUser) { alert('Please sign in'); return; }
      if (!text) { alert('Please enter a description'); return; }
      if (text.length > 1000) { alert('Text too long'); return; }

      btnSubmit.disabled = true;
      submitStatus.textContent = 'Submitting...';
      try {
        await db.collection('submissions').add({
          text,
          tag,
          uid: currentUser.uid,
          email: currentUser.email,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'pending'
        });
        entryText.value = '';
        submitStatus.textContent = 'Submitted (pending approval)';
      } catch (err) {
        submitStatus.textContent = 'Error: ' + err.message;
      } finally {
        btnSubmit.disabled = false;
      }
    });

    // Real-time listener: approved entries
    db.collection('submissions')
      .where('status', '==', 'approved')
      .orderBy('timestamp', 'desc')
      .onSnapshot(snapshot => {
        const items = [];
        snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
        renderApproved(items);
      }, err => {
        console.error('approved onSnapshot error', err);
      });

    // Real-time listener: pending (for admin)
    db.collection('submissions')
      .where('status', '==', 'pending')
      .orderBy('timestamp', 'asc')
      .onSnapshot(snapshot => {
        const items = [];
        snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
        renderPending(items);
      }, err => {
        console.error('pending onSnapshot error', err);
      });

    // Render approved list + counts
    function renderApproved(items) {
      totalCountEl.textContent = items.length;
      const counts = {};
      items.forEach(it => { counts[it.tag] = (counts[it.tag] || 0) + 1; });
      tagCountsEl.innerHTML = '';
      for (const [tag, n] of Object.entries(counts)) {
        const el = document.createElement('div');
        el.className = 'count-card';
        el.textContent = `${tag}: ${n}`;
        tagCountsEl.appendChild(el);
      }
      approvedListEl.innerHTML = '';
      if (items.length === 0) {
        approvedListEl.textContent = 'No approved entries yet.';
        return;
      }
      items.forEach(it => {
        const d = document.createElement('div');
        d.className = 'entry';
        const time = it.timestamp ? new Date(it.timestamp.seconds * 1000).toLocaleString() : '—';
        d.innerHTML = `<div>${escapeHtml(it.text)} <span class="tag">${escapeHtml(it.tag)}</span></div><div class="small">by ${escapeHtml(it.email)} • ${time}</div>`;
        approvedListEl.appendChild(d);
      });
    }

    // Render pending for admin
    function renderPending(items) {
      // Only show pending list if user is signed in and adminSection is visible
      if (!currentUser || getComputedStyle(adminSection).display === 'none') {
        pendingListEl.innerHTML = '<div class="small">No admin access.</div>';
        return;
      }

      if (items.length === 0) {
        pendingListEl.innerHTML = '<div class="small">No pending submissions.</div>';
        return;
      }

      pendingListEl.innerHTML = '';
      items.forEach(it => {
        const d = document.createElement('div');
        d.className = 'entry';
        const time = it.timestamp ? new Date(it.timestamp.seconds * 1000).toLocaleString() : '—';
        d.innerHTML = `<div>${escapeHtml(it.text)} <span class="tag">${escapeHtml(it.tag)}</span></div>
                       <div class="small">from ${escapeHtml(it.email)} • ${time}</div>`;
        const btnApprove = document.createElement('button');
        btnApprove.textContent = 'Approve';
        btnApprove.addEventListener('click', () => changeStatus(it.id, 'approved'));
        const btnReject = document.createElement('button');
        btnReject.textContent = 'Reject';
        btnReject.addEventListener('click', () => changeStatus(it.id, 'rejected'));
        d.appendChild(btnApprove);
        d.appendChild(btnReject);
        pendingListEl.appendChild(d);
      });
    }

    async function changeStatus(docId, newStatus) {
      try {
        await db.collection('submissions').doc(docId).update({ status: newStatus });
      } catch (err) {
        alert('Error changing status: ' + err.message);
      }
    }

    // ---------------- Profile: load/save and real-time personal submissions ----------------

    async function loadUserProfile() {
      if (!currentUser) return;
      profileSaveStatus.textContent = 'Loading...';
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          const data = userDoc.data();
          profileNameEl.value = data.displayName || '';
          profileBioEl.value = data.bio || '';
          profileAvatarEl.value = data.avatarUrl || '';
        } else {
          profileNameEl.value = currentUser.email.split('@')[0] || '';
          profileBioEl.value = '';
          profileAvatarEl.value = '';
        }
        profileSaveStatus.textContent = '';
      } catch (err) {
        console.error('loadUserProfile error', err);
        profileSaveStatus.textContent = 'Error loading profile';
      }
    }

    btnSaveProfile.addEventListener('click', async () => {
      if (!currentUser) { alert('Sign in first'); return; }
      profileSaveStatus.textContent = 'Saving...';
      const docRef = db.collection('users').doc(currentUser.uid);
      const payload = {
        displayName: profileNameEl.value.trim(),
        bio: profileBioEl.value.trim(),
        avatarUrl: profileAvatarEl.value.trim()
      };
      try {
        await docRef.set(payload, { merge: true });
        profileSaveStatus.textContent = 'Saved';
      } catch (err) {
        console.error('save profile error', err);
        profileSaveStatus.textContent = 'Error saving profile';
      }
    });

    // Attach a real-time listener for the current user's submissions so edits/deletes appear live
    function attachMySubmissionsListener() {
      if (!currentUser) return;
      mySubmissionsUnsub = db.collection('submissions')
        .where('uid', '==', currentUser.uid)
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
          const items = [];
          snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
          renderMySubmissions(items);
        }, err => {
          console.error('my submissions onSnapshot error', err);
          mySubmissionsList.textContent = 'Error loading your submissions';
        });
    }

    function renderMySubmissions(items) {
      if (!items || items.length === 0) {
        mySubmissionsList.textContent = 'You have no submissions yet.';
        return;
      }
      mySubmissionsList.innerHTML = '';
      items.forEach(it => {
        const wrapper = document.createElement('div');
        wrapper.className = 'entry';
        const time = it.timestamp ? new Date(it.timestamp.seconds*1000).toLocaleString() : '—';
        wrapper.innerHTML = `<div>${escapeHtml(it.text)} <span class="tag">${escapeHtml(it.tag)}</span></div>
                             <div class="small">status: ${escapeHtml(it.status)} • ${time}</div>`;
        if (it.status === 'pending') {
          const btnEdit = document.createElement('button');
          btnEdit.textContent = 'Edit';
          btnEdit.addEventListener('click', () => editSubmission(it.id, it));
          const btnDelete = document.createElement('button');
          btnDelete.textContent = 'Delete';
          btnDelete.addEventListener('click', () => deleteSubmission(it.id));
          wrapper.appendChild(btnEdit);
          wrapper.appendChild(btnDelete);
        }
        mySubmissionsList.appendChild(wrapper);
      });
    }

    async function editSubmission(docId, data) {
      const newText = prompt('Edit your text', data.text);
      if (newText === null) return;
      const trimmed = newText.trim();
      if (!trimmed) { alert('Text cannot be empty'); return; }
      try {
        await db.collection('submissions').doc(docId).update({ text: trimmed });
        // real-time listener will refresh the list
      } catch (err) {
        alert('Error updating: ' + err.message);
      }
    }

    async function deleteSubmission(docId) {
      if (!confirm('Delete this submission?')) return;
      try {
        await db.collection('submissions').doc(docId).delete();
        // real-time listener will refresh the list
      } catch (err) {
        alert('Delete failed: ' + err.message);
      }
    }

    // Basic HTML escape to show user input safely
    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // Note: keep Firestore rules server-side properly configured (owners only, admin checks).
  </script>
</body>
